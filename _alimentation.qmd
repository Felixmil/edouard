{{< include _setup.qmd >}}

## üçº Alimentation

::: {.callout-note title='R√©sum√©'}
Au cours des 24 derni√®res heures, √âdouard a bu **`r get_latest_daily_bottles(data)`** biberons, pour un total de **`r get_latest_daily_volume(data)`** ml de lait.
:::

### Volume total quotidien

```{r}
# Filter for milk quantity data
milk_data <- get_milk_data(data)

# Create the plot with trend line and confidence interval
colors <- edouard_colors()

# Calculate daily total milk volume
daily_volume <- milk_data |>
  mutate(date_only = as.Date(datetime)) |>
  group_by(date_only) |>
  summarise(
    total_volume = sum(value, na.rm = TRUE),
    n_bottles = n(),
    avg_volume = mean(value, na.rm = TRUE),
    .groups = "drop"
  )

# Create plot with bars and trend line
ggplot(daily_volume, aes(x = date_only, y = total_volume)) +
  # Bars for daily totals
  geom_col(
    fill = colors[3],
    alpha = 0.7,
    width = 0.8
  ) +
  # Add value labels on top of bars
  geom_text(
    aes(label = round(total_volume)),
    vjust = -0.5,
    size = 2.5,
    color = "gray30",
    fontface = "bold"
  ) +
  scale_x_date(date_labels = "%d %b", date_breaks = "3 days") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
  labs(
    y = "Volume total (ml)",
    x = NULL
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank()
  )
```

### Volume par biberon
```{r}
plot_volume <- milk_data |>
  mutate(
    tooltip = if_else(!is.na(notes), notes, ""),
    has_notes = !is.na(notes)
  ) |>
  ggplot(aes(x = datetime, y = value)) +
  # Confidence interval (shows expected range)
  geom_smooth(
    method = "loess",
    span = 0.3,
    color = colors[1],
    fill = colors[1],
    alpha = 0.2,
    linewidth = 1
  ) +
  # Individual bottle points
  geom_point_interactive(
    aes(tooltip = tooltip, data_id = datetime, color = has_notes),
    fill = colors[3],
    size = 2.5,
    stroke = 0.5,
    shape = 21,
    hover_nearest = TRUE
  ) +
  scale_color_manual(
    values = c("TRUE" = "#04538cff", "FALSE" = colors[3]),
    guide = "none"
  ) +
  labs(
    y = "Volume (ml)",
    x = NULL
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.caption = element_text(hjust = 0, color = "gray40", size = 9)
  )

girafe(
  ggobj = plot_volume,
  options = list(opts_sizing(rescale = TRUE, width = .8))
)
```

### Temps entre les biberons
```{r}
# Calculate time intervals between bottles
intervals_data <- milk_data |>
  arrange(datetime) |>
  mutate(
    time_diff = as.numeric(difftime(datetime, lag(datetime), units = "hours")),
    date_only = as.Date(datetime)
  ) |>
  filter(!is.na(time_diff))

# Calculate daily averages for each day
daily_avg <- intervals_data |>
  group_by(date_only) |>
  summarise(
    avg_interval = mean(time_diff, na.rm = TRUE),
    n_bottles = n(),
    .groups = "drop"
  )

# Create plot with intervals by date and daily average line
plot_intervals <- intervals_data |>
  mutate(
    tooltip = if_else(!is.na(notes), notes, ""),
    has_notes = !is.na(notes)
  ) |>
  ggplot() +
  # Daily average line with confidence interval
  geom_smooth(
    data = daily_avg,
    aes(x = date_only, y = avg_interval),
    method = "loess",
    span = 0.5,
    color = colors[1],
    fill = colors[1],
    alpha = 0.2,
    linewidth = 1.2
  ) +
  # Individual interval points grouped by day
  geom_point_interactive(
    aes(
      x = date_only,
      y = time_diff,
      tooltip = tooltip,
      data_id = datetime,
      color = has_notes
    ),
    fill = colors[3],
    size = 2.5,
    stroke = 0.5,
    shape = 21,
    hover_nearest = TRUE
  ) +

  scale_color_manual(
    values = c("TRUE" = "#04538cff", "FALSE" = colors[3]),
    guide = "none"
  ) +
  scale_x_date(date_labels = "%d %b", date_breaks = "3 days") +
  labs(
    y = "Temps √©coul√© (heures)",
    x = NULL
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.caption = element_text(hjust = 0, color = "gray40", size = 9)
  )

girafe(
  ggobj = plot_intervals,
  options = list(opts_sizing(rescale = TRUE, width = .8))
)
```
